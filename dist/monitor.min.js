!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FrontMonitor=t()}(this,function(){"use strict";var e,t={appId:"fm-unnamed",reportFields:["colno","lineno","filename","message"],sameOrigin:!0,distinct:!0,cacheKey:"FrontMonitorCache",cacheLimit:50,bufferTime:5e3,bufferSize:10,xhrErrorLevel:"ALL",xhrErrorMessage:"message",catchUnhandledRejection:!0};!function(e){e.RUNTIME="RUNTIME",e.RESOURCE="RESOURCE",e.UNHANDLEDREJECTION="UNHANDLEDREJECTION",e.XMLHTTPREQUEST="XMLHTTPREQUEST"}(e||(e={}));var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}();function i(e){console.error("[Front-Monitor Error]: "+e)}function s(e){return"object"===(void 0===e?"undefined":n(e))&&null!==e}function a(e){return"string"==typeof e}var c,u,f=(c=window.location.protocol+"//"+document.domain+(window.location.port?":"+window.location.port:""),function(e){return 0===e.indexOf(c)}),l=function(){function e(t,n){r(this,e),this.appId=t,this.url=n}return o(e,[{key:"report",value:function(e){var t="?appId="+encodeURIComponent(this.appId)+"&ua="+encodeURIComponent(navigator.userAgent)+"&records="+encodeURIComponent(JSON.stringify(e)),n=new Image;n.onload=function(){n=null},n.src=""+this.url+t}}]),e}(),h=function(){function e(t,n,o,s,a,c){r(this,e),this.distinct=n,this.cacheKey=o,this.cacheLimit=s,this.bufferTime=a,this.bufferSize=c,this.reporter=t;var u=window.localStorage.getItem(this.cacheKey);if(u){try{this.queue=JSON.parse(u),this.queue.length&&this.startTimer()}catch(e){i("load cached error records failed"),this.queue=[]}window.localStorage.removeItem(this.cacheKey)}else this.queue=[]}return o(e,[{key:"startTimer",value:function(){!this.timer&&(this.timer=setTimeout(this.flush.bind(this),this.bufferTime))}},{key:"cacheRecords",value:function(){window.localStorage.setItem(this.cacheKey,JSON.stringify(this.queue))}},{key:"push",value:function(e){this.queue.length>=this.cacheLimit||this.distinct&&this.queue.some(function(t){return r=e,(n=t).type===r.type&&n.colno===r.colno&&n.lineno===r.lineno&&n.filename===r.filename&&n.message===r.message;var n,r})||(this.queue.push(e),this.cacheRecords(),this.startTimer())}},{key:"flush",value:function(){var e=this.queue.splice(0,this.bufferSize);e.length&&(this.reporter.report(e),this.cacheRecords()),this.queue.length&&this.startTimer()}}]),e}();return void 0===(u=window)?(i("monitor need browser-like environment"),function(){}):function(n){if(a(n)&&(n={reportUrl:n}),!s(n)||!a(n.reportUrl)||!n.reportUrl.length)return i("invalid report url");var r,o,c=Object.assign({},t,n),d=(r=c.reportFields,function(e){var t=Object.create(null);return r.forEach(function(n){t[n]=e[n]||""}),t.timestamp=Date.now(),t.type=e.custom_type,t}),p=(o=c.xhrErrorLevel,function(e){return e+="",a(o)?/^all$/i.test(o)?"200"!==o:o.split("/").indexOf(e)>-1:o instanceof RegExp&&o.test(e)}),m=new l(c.appId,c.reportUrl),y=new h(m,c.distinct,c.cacheKey,c.cacheLimit,c.bufferTime,c.bufferSize),g=function(e){return function(t){t.custom_type=e,y.push(d(t))}};!function(t,n,r,o){var i=n(e.RUNTIME),a=n(e.RESOURCE);if(t.addEventListener("error",function(e){e.target===t?r&&!f(e.filename)||i(e):e.target instanceof HTMLElement&&a({colno:0,lineno:0,filename:e.target.src||e.target.href,message:"load "+e.target.tagName+" resource failed"})},!0),o){var c=n(e.UNHANDLEDREJECTION);t.addEventListener("unhandledrejection",function(e){var t=s(e.reason)?e.reason.stack:e.reason;c({colno:0,lineno:0,filename:"",message:t})},!0)}}(u,g,c.sameOrigin,c.catchUnhandledRejection),function(t,n){var r=n(e.XMLHTTPREQUEST),o=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(){for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];var s=n[0],a=n[1],c=n[2];return this.addEventListener&&this.addEventListener("loadend",function(){t(this.status)&&r({colno:0,lineno:0,filename:a,message:s.toUpperCase()+"("+(c?"asynchronous":"synchronous")+") the service resource failed with status:"+this.status})}),o.apply(this,n)}}(p,g)}});
